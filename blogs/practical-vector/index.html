<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>What if? Practical parallel data. | Cedric Bail</title>
<meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Using a hypothetical `go for` construct to implement a variety of string operation"><meta name=generator content="Hugo 0.136.0"><meta name=robots content="index, follow"><meta name=author content="Cedric Bail"><link rel=stylesheet href=/ananke/css/main.min.b3c9b096ae6eeeda4ad54a0732df5f88066f9973f3d966a315b2014cf76b8bc2.css><link rel=canonical href=http://bluebugs.github.io/blogs/practical-vector/><meta property="og:url" content="http://bluebugs.github.io/blogs/practical-vector/"><meta property="og:site_name" content="Cedric Bail"><meta property="og:title" content="What if? Practical parallel data."><meta property="og:description" content="Using a hypothetical `go for` construct to implement a variety of string operation"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2025-06-21T14:38:38-07:00"><meta property="article:modified_time" content="2025-06-21T14:38:38-07:00"><meta itemprop=name content="What if? Practical parallel data."><meta itemprop=description content="Using a hypothetical `go for` construct to implement a variety of string operation"><meta itemprop=datePublished content="2025-06-21T14:38:38-07:00"><meta itemprop=dateModified content="2025-06-21T14:38:38-07:00"><meta itemprop=wordCount content="931"><meta name=twitter:card content="summary"><meta name=twitter:title content="What if? Practical parallel data."><meta name=twitter:description content="Using a hypothetical `go for` construct to implement a variety of string operation"></head><body class="ma0 avenir bg-near-white production"><header class="cover bg-center" style=background-image:url(http://bluebugs.github.io/images/lakelouise.jpg)><div class=bg-black-60><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Cedric Bail</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/blogs/ title="Blog page">Blog</a></li></ul><div class=ananke-socials></div></div></div></nav><div class="tc-l pv6 ph3 ph4-ns"><div class="f2 f1-l fw2 white-90 mb0 lh-title">What if? Practical parallel data.</div><div class="fw1 f5 f3-l white-80 measure-wide-l center lh-copy mt3 mb4">Using a hypothetical `go for` construct to implement a variety of string operation</div></div></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked ttu">Blog</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">What if? Practical parallel data.</h1><p class=tracked>By <strong>Cedric Bail</strong></p><time class="f6 mv4 dib tracked" datetime=2025-06-21T14:38:38-07:00>June 21, 2025</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links black pr4-l w-two-thirds-l"><h2 id=printf-helper>Printf helper</h2><p>One of the first and most repetitive tasks for <a href=https://github.com/golang/go/blob/master/src/fmt/print.go#L1028>doPrintf</a> is to find <code>%</code> in a string. Right now, this is just iterating one character after another. This is very simple to parallelize using data parallelism and would look like the code below.</p><div class=spmd-container-printf-verbs><div id=spmd-demo-printf-verbs class=spmd-demo><div class=spmd-code-pane><pre><code id=spmd-go-code_printf-verbs class=language-go>
<span class=code-line id=line-1><span class=gokw>func</span> <span class=gofn>printfVerb</span>(<span class=govar>format</span> <span class=goty>string</span>) <span class=goty>int</span> {</span>
<span class=code-line id=line-2>  <span class=gokw>go</span> <span class=gokw>for</span> <span class=govar>_</span>, <span class=govar>c</span> := <span class=gokw>range</span> <span class=govar>format</span> {</span>
<span class=code-line id=line-3>    <span class=govar>check</span> := <span class=govar>c</span> == <span class=gohypo>'%'</span></span>
<span class=code-line id=line-4>    <span class=gokw>if</span> <span class=gofn>reduce.Any</span>(<span class=govar>check</span>) {</span>
<span class=code-line id=line-5>        <span class=gokw>return</span> <span class=gofn>reduce.FindFirstSet</span>(<span class=govar>check</span>)</span>
<span class=code-line id=line-6>    }</span>
<span class=code-line id=line-7>  }</span>
<span class=code-line id=line-8>  <span class=gokw>return</span> <span class=gofn>len</span>(<span class=govar>format</span>)</span>
<span class=code-line id=line-9>}</span>
            </code></pre></div><div class=spmd-viz-pane><div class=spmd-lane-data-grid><div class=spmd-grid-label></div><div class=spmd-grid-header>Lane 0</div><div class=spmd-grid-header>Lane 1</div><div class=spmd-grid-header>Lane 2</div><div class=spmd-grid-header>Lane 3</div><div class=spmd-grid-label>c</div><div id=val-c-0 class="spmd-grid-cell spmd-grid-cell-c"></div><div id=val-c-1 class="spmd-grid-cell spmd-grid-cell-c"></div><div id=val-c-2 class="spmd-grid-cell spmd-grid-cell-c"></div><div id=val-c-3 class="spmd-grid-cell spmd-grid-cell-c"></div><div class=spmd-grid-label>check</div><div id=val-check-0 class="spmd-grid-cell spmd-grid-cell-check"></div><div id=val-check-1 class="spmd-grid-cell spmd-grid-cell-check"></div><div id=val-check-2 class="spmd-grid-cell spmd-grid-cell-check"></div><div id=val-check-3 class="spmd-grid-cell spmd-grid-cell-check"></div></div><div class=spmd-final-result><h4>Final Result</h4><span class=spmd-result-label>First occurence of '%':</span>
<span id=final-result-printf-verbs class=spmd-final-value-text>---</span></div><div class=spmd-controls><button id=prev-printf-verbs>Previous</button>
<button id=next-printf-verbs>Next</button></div></div></div><div id=info-pane-printf-verbs class=spmd-info-pane><h4>Execution Step</h4><p id=info-printf-verbs>Click "Start" to begin the visualization.</p></div></div><style>.spmd-container-printf-verbs{border:1px solid #ccc;padding:10px;border-radius:8px;background-color:#f9f9f9;box-shadow:0 2px 4px rgba(0,0,0,.1);max-width:900px;margin:20px auto}#spmd-demo-printf-verbs{border:none;box-shadow:none;margin-bottom:10px}#spmd-demo-printf-verbs .spmd-lane-data-grid{grid-template-columns:auto repeat(4,1fr)}#spmd-demo-printf-verbs .inactive-lane{background-color:#f0f0f0!important;color:#aaa}#spmd-demo-printf-verbs .spmd-controls{text-align:center;margin-top:20px}#spmd-demo-printf-verbs .spmd-result-label{margin-right:8px;font-weight:500;color:#333}</style><script>document.addEventListener("DOMContentLoaded",function(){const s=document.getElementById("prev-printf-verbs"),o=document.getElementById("next-printf-verbs"),i=document.getElementById("info-printf-verbs"),a=document.getElementById("final-result-printf-verbs"),r=document.querySelectorAll("#spmd-go-code_printf-verbs .code-line"),c=4,d="ab%d";let e=0;const t=[{line:1,info:`Calling <code class="spmd-inline-code"><span class="gofn">printfVerb</span>(<span class="gohypo">"ab%d"</span>)</code>. Input <code class="spmd-inline-code">format</code> is initialized. Four execution lanes available.`,c:["—","—","—","—"],check:["—","—","—","—"],result:"---"},{line:2,info:`Loop starts. Each lane gets a character from <code class="spmd-inline-code">format</code>.`,c:[`'a'`,`'b'`,`'%'`,`'d'`],check:["—","—","—","—"],result:"---"},{line:3,info:`Each lane checks if its character <code class="spmd-inline-code">c</code> is equal to <code class="spmd-inline-code gokw">'%'</code>. The result is stored in the intermediate variable <code class="spmd-inline-code">check</code>.`,c:[`'a'`,`'b'`,`'%'`,`'d'`],check:["false","false","true","false"],result:"---"},{line:4,info:`<code class="spmd-inline-code"><span class="gofn">reduce.Any</span>(<span class="govar">check</span>)</code> checks if any lane found a <code class="spmd-inline-code gokw">'%'</code>. Result is <code class="spmd-inline-code">true</code>.`,c:[`'a'`,`'b'`,`'%'`,`'d'`],check:["false","false","true","false"],result:"---"},{line:5,info:`Since a <code class="spmd-inline-code gokw">'%'</code> was found, <code class="spmd-inline-code"><span class="gofn">reduce.FindFirstSet</span>(<span class="govar">check</span>)</code> finds the index of the first lane where <code class="spmd-inline-code">check</code> is true.`,c:[`'a'`,`'b'`,`'%'`,`'d'`],check:["false","false","true","false"],result:2},{line:9,info:`The function returns <code class="spmd-inline-code">2</code>. The visualization has ended.`,c:[`'a'`,`'b'`,`'%'`,`'d'`],check:["false","false","true","false"],result:2}];function l(e){r.forEach(e=>e.classList.remove("highlight")),e>0&&document.getElementById(`line-${e}`).classList.add("highlight")}function n(e){const n=t[e];l(n.line),i.innerHTML=n.info,a.textContent=n.result;for(let e=0;e<c;e++)document.getElementById(`val-c-${e}`).textContent=n.c[e],document.getElementById(`val-check-${e}`).textContent=n.check[e];s.disabled=e===0,o.disabled=e===t.length-1}s.addEventListener("click",()=>{e>0&&(e--,n(e))}),o.addEventListener("click",()=>{e<t.length-1&&(e++,n(e))}),n(0)})</script><p>One of the important bit of this example is the use <code>reduce.Any</code> inside a <code>go for</code> loop. This make the <code>if</code> act like a normal <code>if</code> with a jump and enable a quick exit as soon as at least one <code>%</code> is found. This is still readable and maintainable. I would think this could be acceptable in the Go standard library codebase once this feature is properly ready for prime time.</p><h2 id=encode-hexadecimal>Encode hexadecimal</h2><p>Hexadecimal encoding and decoding are relatively <a href=https://github.com/golang/go/issues/68188>slow</a> and would benefit from using SIMD instructions. If we look at the current implementation for hex.Encode in Go&rsquo;s standard library:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>src</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>j</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>src</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>dst</span>[<span style=color:#a6e22e>j</span>] = <span style=color:#a6e22e>hextable</span>[<span style=color:#a6e22e>v</span><span style=color:#f92672>&gt;&gt;</span><span style=color:#ae81ff>4</span>]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>dst</span>[<span style=color:#a6e22e>j</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>] = <span style=color:#a6e22e>hextable</span>[<span style=color:#a6e22e>v</span><span style=color:#f92672>&amp;</span><span style=color:#ae81ff>0x0f</span>]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>j</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> len(<span style=color:#a6e22e>src</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If we adapt it to use <code>go for</code> and parallelize the data manipulation, we get the following example:</p><div id=spmd-hex-container-1 class=spmd-container><div id=spmd-demo-hex class=spmd-demo><div class=spmd-code-pane><pre><code id=spmd-go-code_hex class=language-go>
<span class=code-line id=line-1><span class=gokw>func</span> <span class=gofn>Encode</span><span class=gopunct>(</span><span class=govar>dst</span><span class=gopunct>,</span> <span class=govar>src</span> <span class=goty>[]byte</span><span class=gopunct>)</span> <span class=goty>int</span> <span class=gopunct>{</span></span>
<span class=code-line id=line-2>  <span class=gokw>go</span> <span class=gokw>for</span> <span class=govar>i</span> <span class=goop>:=</span> <span class=gokw>range</span> <span class=gofn>len</span><span class=gopunct>(</span><span class=govar>src</span><span class=gopunct>)</span> <span class=goop>*</span> <span class=gonum>2</span> <span class=gopunct>{</span></span>
<span class=code-line id=line-3>    <span class=govar>v</span> <span class=goop>:=</span> <span class=govar>src</span><span class=gopunct>[</span><span class=govar>i</span><span class=goop>>></span><span class=gonum>1</span><span class=gopunct>]</span></span>
<span class=code-line id=line-4>    <span class=govar>shift</span> <span class=goop>:=</span> <span class=gopunct>(</span><span class=gonum>1</span> <span class=goop>-</span> <span class=gopunct>(</span><span class=govar>i</span> <span class=goop>&</span> <span class=gonum>1</span><span class=gopunct>))</span> <span class=goop>*</span> <span class=gonum>4</span></span>
<span class=code-line id=line-5>    <span class=govar>dst</span><span class=gopunct>[</span><span class=govar>i</span><span class=gopunct>]</span> <span class=goop>=</span> <span class=govar>hextable</span><span class=gopunct>[(</span><span class=govar>v</span><span class=goop>>></span><span class=govar>shift</span><span class=gopunct>)</span><span class=goop>&</span><span class=gonum>0x0f</span><span class=gopunct>]</span></span>
<span class=code-line id=line-6>  <span class=gopunct>}</span></span>
<span class=code-line id=line-7>  <span class=gokw>return</span> <span class=gofn>len</span><span class=gopunct>(</span><span class=govar>src</span><span class=gopunct>)</span> <span class=goop>*</span> <span class=gonum>2</span></span>
<span class=code-line id=line-8><span class=gopunct>}</span></span>
            </code></pre></div><div class=spmd-viz-pane><div class=spmd-lane-data-grid><div class=spmd-grid-label></div><div class=spmd-grid-header>Lane 0</div><div class=spmd-grid-header>Lane 1</div><div class=spmd-grid-header>Lane 2</div><div class=spmd-grid-header>Lane 3</div><div class=spmd-grid-label>i</div><div id=val-i-0 class=spmd-grid-cell></div><div id=val-i-1 class=spmd-grid-cell></div><div id=val-i-2 class=spmd-grid-cell></div><div id=val-i-3 class=spmd-grid-cell></div><div class=spmd-grid-label>v</div><div id=val-v-0 class=spmd-grid-cell></div><div id=val-v-1 class=spmd-grid-cell></div><div id=val-v-2 class=spmd-grid-cell></div><div id=val-v-3 class=spmd-grid-cell></div><div class=spmd-grid-label>shift</div><div id=val-shift-0 class=spmd-grid-cell></div><div id=val-shift-1 class=spmd-grid-cell></div><div id=val-shift-2 class=spmd-grid-cell></div><div id=val-shift-3 class=spmd-grid-cell></div><div class=spmd-grid-label>dst[i]</div><div id=val-dst-0 class=spmd-grid-cell></div><div id=val-dst-1 class=spmd-grid-cell></div><div id=val-dst-2 class=spmd-grid-cell></div><div id=val-dst-3 class=spmd-grid-cell></div></div><div class=spmd-final-result><h4>dst content</h4><span id=final-result-hex class=spmd-final-value-text>---</span></div><div class=spmd-controls><button id=prev-hex>Previous</button>
<button id=next-hex>Next</button></div></div></div><div id=info-pane-hex class=spmd-info-pane><h4>Execution Step</h4><p id=info-hex>Click "Next" to begin the visualization.</p></div></div><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("spmd-hex-container-1");if(!e)return;const u=e.querySelector("#prev-hex"),l=e.querySelector("#next-hex"),p=e.querySelector("#info-hex"),f=e.querySelector("#final-result-hex"),c=e.querySelector("#spmd-go-code_hex"),h=c.querySelectorAll(".code-line"),t=4,r="Hello world",a=Array.from(r).map(e=>e.charCodeAt(0)),m="0123456789abcdef";let s=0;const o=[],n=[];n.push({line:0,info:`Calling <code class="spmd-inline-code"><span class="gofn">Encode</span>(<span class="govar">dst</span>, []<span class="goty">byte</span>("Hello world"))</code>. Input <code class="spmd-inline-code"><span class="govar">src</span></code> is initialized, <code class="spmd-inline-code"><span class="govar">dst</span></code> is expected to have the right allocate length. Four execution lanes available.`,lanes:{},result:"''"}),n.push({line:2,info:`The <code class="spmd-inline-code"><span class="gokw">go</span> <span class="gokw">for</span></code> loop begins. It will execute <code class="spmd-inline-code"><span class="gofn">len</span>(<span class="govar">src</span>) * 2</code> (22) iterations in parallel across the available lanes. The first four iterations (i=0, 1, 2, 3) are assigned to the lanes.`,lanes:{i:[0,1,2,3],v:Array(4).fill(null),shift:Array(4).fill(null),dst:Array(4).fill(null)},result:"''"});const d=a.length*2;for(let e=0;e<d;e+=t){const s=[],i=[],c=[],u=[],l=Math.min(t,d-e);for(let n=0;n<t;n++)if(n<l){const t=e+n;s[n]=t;const o=t>>1;i[n]=`'${r[o]}' (0x${a[o].toString(16)})`}else s[n]="---",i[n]="---";n.push({line:3,info:`Processing indices ${e}-${e+l-1}. For each lane, we "gather" the corresponding byte from <code class="spmd-inline-code"><span class="govar">src</span></code>. For example, lanes for <code class="spmd-inline-code">i=0</code> and <code class="spmd-inline-code">i=1</code> both read from <code class="spmd-inline-code"><span class="govar">src</span>[0]</code>.`,lanes:{i:s,v:i,shift:Array(t).fill(null),dst:Array(t).fill(null)},result:`'${o.join("")}'`});for(let n=0;n<t;n++)if(n<l){const t=e+n;c[n]=(1-(t&1))*4}else c[n]="---";n.push({line:4,info:`Calculate the <code class="spmd-inline-code"><span class="govar">shift</span></code> amount. For even indices, we need the high nibble (shift by 4). For odd indices, we need the low nibble (shift by 0).`,lanes:{i:s,v:i,shift:c,dst:Array(t).fill(null)},result:`'${o.join("")}'`});for(let n=0;n<t;n++)if(n<l){const t=e+n,i=a[t>>1],r=(1-(t&1))*4,s=m[i>>r&15];u[n]=`'${s}'`,o[t]=s}else u[n]="---";n.push({line:5,info:`The resulting hex character is written to <code class="spmd-inline-code"><span class="govar">dst</span></code>. This is a "scatter" operation, as each active lane writes to a unique position.`,lanes:{i:s,v:i,shift:c,dst:u},result:`'${o.join("")}'`})}n.push({line:7,info:"Loop finished. The final encoded string is complete.",lanes:{i:Array(t).fill("---"),v:Array(t).fill("---"),shift:Array(t).fill("---"),dst:Array(t).fill("---")},result:`'${o.join("")}'`});function g(e){if(h.forEach(e=>e.classList.remove("highlight")),e>0){const t=c.querySelector(`#line-${e}`);t&&t.classList.add("highlight")}}function i(s){const o=n[s];g(o.line),p.innerHTML=o.info,f.textContent=o.result;for(let n=0;n<t;n++){const s=o.lanes.i&&o.lanes.i[n]!=null?o.lanes.i[n]:"---";e.querySelector(`#val-i-${n}`).textContent=s,e.querySelector(`#val-v-${n}`).textContent=o.lanes.v&&o.lanes.v[n]!=null?o.lanes.v[n]:"---",e.querySelector(`#val-shift-${n}`).textContent=o.lanes.shift&&o.lanes.shift[n]!=null?o.lanes.shift[n]:"---",e.querySelector(`#val-dst-${n}`).textContent=o.lanes.dst&&o.lanes.dst[n]!=null?o.lanes.dst[n]:"---";const i=e.querySelector(`#val-i-${n}`),a=e.querySelector(`#val-v-${n}`),r=e.querySelector(`#val-shift-${n}`),c=e.querySelector(`#val-dst-${n}`);s==="---"?(i.classList.add("inactive-lane"),a.classList.add("inactive-lane"),r.classList.add("inactive-lane"),c.classList.add("inactive-lane")):(i.classList.remove("inactive-lane"),a.classList.remove("inactive-lane"),r.classList.remove("inactive-lane"),c.classList.remove("inactive-lane"))}u.disabled=s===0,l.disabled=s===n.length-1}u.addEventListener("click",()=>{s>0&&(s--,i(s))}),l.addEventListener("click",()=>{s<n.length-1&&(s++,i(s))}),i(0)})</script><p>There are different ways to do the index access. We could have also used an if statement for both index cases, but the most important change is that we are expressing the operation on one lane at a time. This enables the compiler to automatically adapt the code to whatever number of lanes are available and use proper linear memory access, which is the most efficient way to manipulate data. It is critical when doing SIMD to be very efficient with memory access, as that often ends up being the limiting factor.</p><h2 id=bytestoupper>bytes.ToUpper</h2><p>Last practical example. For bytes.ToUpper, the Go standard library has a fast path when the string consists only of ASCII characters. We can make that fast path even faster using SIMD and data parallelism. Here is what the code would look like:</p><div id=spmd-toupper-container-2 class=spmd-container><div id=spmd-demo-toupper class=spmd-demo><div class=spmd-code-pane><pre><code id=spmd-go-code_toupper class=language-go>
<span class=code-line id=line-1><span class=gokw>func</span> <span class=gofn>ToUpper</span><span class=gopunct>(</span><span class=govar>s</span> <span class=goty>[]byte</span><span class=gopunct>)</span> <span class=goty>[]byte</span> <span class=gopunct>{</span></span>
<span class=code-line id=line-2>    <span class=gokw>var</span> <span class=govar>hasLower</span> <span class=gohypo>varying</span> <span class=goty>bool</span></span>
<span class=code-line id=line-3>    <span class=govar>isASCII</span> <span class=goop>:=</span> <span class=gonum>true</span></span>
<span class=code-line id=line-4>    <span class=gokw>go</span> <span class=gokw>for</span> <span class=govar>_</span><span class=gopunct>,</span> <span class=govar>c</span> <span class=goop>:=</span> <span class=gokw>range</span> <span class=govar>s</span> <span class=gopunct>{</span></span>
<span class=code-line id=line-5>        <span class=gokw>if</span> <span class=gofn>reduce.Any</span><span class=gopunct>(</span><span class=govar>c</span> <span class=goop>>=</span> <span class=govar>utf8.RuneSelf</span><span class=gopunct>)</span> <span class=gopunct>{</span></span>
<span class=code-line id=line-6>            <span class=govar>isASCII</span> <span class=goop>=</span> <span class=gonum>false</span></span>
<span class=code-line id=line-7>            <span class=gokw>break</span></span>
<span class=code-line id=line-8>        <span class=gopunct>}</span></span>
<span class=code-line id=line-9>        <span class=govar>hasLower</span> <span class=goop>=</span> <span class=govar>hasLower</span> <span class=goop>||</span> <span class=gopunct>(</span><span class=gohypo>'a'</span> <span class=goop>&lt;=</span> <span class=govar>c</span> <span class=goop>&&</span> <span class=govar>c</span> <span class=goop>&lt;=</span> <span class=gohypo>'z'</span><span class=gopunct>)</span></span>
<span class=code-line id=line-10>    <span class=gopunct>}</span></span>
<span class=code-line id=line-11>    <span class=gokw>if</span> <span class=govar>isASCII</span> <span class=gopunct>{</span> <span class=gocomment>// optimize for ASCII-only byte slices.</span></span>
<span class=code-line id=line-12>        <span class=gokw>if</span> <span class=gofn>reduce.All</span><span class=gopunct>(</span><span class=goop>!</span><span class=govar>hasLower</span><span class=gopunct>)</span> <span class=gopunct>{</span></span>
<span class=code-line id=line-13>            <span class=gokw>return</span> <span class=gofn>append</span><span class=gopunct>(</span><span class=goty>[]byte</span><span class=gopunct>(</span><span class=gohypo>""</span><span class=gopunct>),</span> <span class=govar>s</span><span class=gopunct>...)</span></span>
<span class=code-line id=line-14>        <span class=gopunct>}</span></span>
<span class=code-line id=line-15>        <span class=govar>b</span> <span class=goop>:=</span> <span class=gofn>bytealg.MakeNoZero</span><span class=gopunct>(</span><span class=gofn>len</span><span class=gopunct>(</span><span class=govar>s</span><span class=gopunct>))[:</span><span class=gofn>len</span><span class=gopunct>(</span><span class=govar>s</span><span class=gopunct>):</span><span class=gofn>len</span><span class=gopunct>(</span><span class=govar>s</span><span class=gopunct>)]</span></span>
<span class=code-line id=line-16>        <span class=gokw>go</span> <span class=gokw>for</span> <span class=govar>i</span><span class=gopunct>,</span> <span class=govar>c</span> <span class=goop>:=</span> <span class=gokw>range</span> <span class=govar>s</span> <span class=gopunct>{</span></span>
<span class=code-line id=line-17>            <span class=gokw>if</span> <span class=gohypo>'a'</span> <span class=goop>&lt;=</span> <span class=govar>c</span> <span class=goop>&&</span> <span class=govar>c</span> <span class=goop>&lt;=</span> <span class=gohypo>'z'</span> <span class=gopunct>{</span></span>
<span class=code-line id=line-18>                <span class=govar>c</span> <span class=goop>-=</span> <span class=gohypo>'a'</span> <span class=goop>-</span> <span class=gohypo>'A'</span></span>
<span class=code-line id=line-19>            <span class=gopunct>}</span></span>
<span class=code-line id=line-20>            <span class=govar>b</span><span class=gopunct>[</span><span class=govar>i</span><span class=gopunct>]</span> <span class=goop>=</span> <span class=govar>c</span></span>
<span class=code-line id=line-21>        <span class=gopunct>}</span></span>
<span class=code-line id=line-22>        <span class=gokw>return</span> <span class=govar>b</span></span>
<span class=code-line id=line-23>    <span class=gopunct>}</span></span>
<span class=code-line id=line-24>    <span class=gokw>return</span> <span class=gofn>Map</span><span class=gopunct>(</span><span class=govar>unicode.ToUpper</span><span class=gopunct>,</span> <span class=govar>s</span><span class=gopunct>)</span></span>
<span class=code-line id=line-25><span class=gopunct>}</span></span>
            </code></pre></div><div class=spmd-viz-pane><div class=spmd-lane-data-grid><div class=spmd-grid-label></div><div class=spmd-grid-header>Lane 0</div><div class=spmd-grid-header>Lane 1</div><div class=spmd-grid-header>Lane 2</div><div class=spmd-grid-header>Lane 3</div><div class=spmd-grid-label>mask</div><div id=val-mask-0 class=spmd-grid-cell>true</div><div id=val-mask-1 class=spmd-grid-cell>true</div><div id=val-mask-2 class=spmd-grid-cell>true</div><div id=val-mask-3 class=spmd-grid-cell>true</div><div class=spmd-grid-label>c</div><div id=val-c-0 class=spmd-grid-cell></div><div id=val-c-1 class=spmd-grid-cell></div><div id=val-c-2 class=spmd-grid-cell></div><div id=val-c-3 class=spmd-grid-cell></div><div class=spmd-grid-label>hasLower</div><div id=val-hasLower-0 class=spmd-grid-cell></div><div id=val-hasLower-1 class=spmd-grid-cell></div><div id=val-hasLower-2 class=spmd-grid-cell></div><div id=val-hasLower-3 class=spmd-grid-cell></div><div class=spmd-grid-label>'a' &lt;= c && c &lt;= 'z'</div><div id=val-isLower-0 class=spmd-grid-cell></div><div id=val-isLower-1 class=spmd-grid-cell></div><div id=val-isLower-2 class=spmd-grid-cell></div><div id=val-isLower-3 class=spmd-grid-cell></div><div class=spmd-grid-label>upperC</div><div id=val-upperC-0 class=spmd-grid-cell></div><div id=val-upperC-1 class=spmd-grid-cell></div><div id=val-upperC-2 class=spmd-grid-cell></div><div id=val-upperC-3 class=spmd-grid-cell></div></div><div class=spmd-final-result><h4>Result</h4><span class=spmd-result-label>isASCII:</span>
<span id=isASCII-result class=spmd-final-value-text>true</span><br><span class=spmd-result-label>Result:</span>
<span id=final-result-toupper class=spmd-final-value-text>---</span></div><div class=spmd-controls><button id=prev-toupper>Previous</button>
<button id=next-toupper>Next</button></div></div></div><div id=info-pane-toupper class=spmd-info-pane><h4>Execution Step</h4><p id=info-toupper>Click "Next" to begin the visualization.</p></div></div><style>.spmd-container{border:1px solid #ccc;padding:10px;border-radius:8px;background-color:#f9f9f9;box-shadow:0 2px 4px rgba(0,0,0,.1);max-width:900px;margin:20px auto}#spmd-demo-toupper{border:none;box-shadow:none;margin-bottom:10px}#spmd-demo-toupper .spmd-lane-data-grid{font-size:.85em}#spmd-demo-toupper .spmd-grid-label{font-size:.8em}#spmd-demo-toupper .spmd-grid-cell{font-size:.8em;padding:6px 3px}#spmd-demo-toupper .spmd-grid-header{font-size:.85em}#spmd-demo-toupper .inactive-lane{background-color:#f0f0f0!important;color:#aaa}#spmd-demo-toupper .spmd-controls{text-align:center;margin-top:20px}#spmd-demo-toupper .spmd-result-label{margin-right:8px;font-weight:500;color:#333}</style><script>document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("spmd-toupper-container-2");if(!t)return;const m=t.querySelector("#prev-toupper"),h=t.querySelector("#next-toupper"),b=t.querySelector("#info-toupper"),v=t.querySelector("#final-result-toupper"),g=t.querySelector("#isASCII-result"),d=t.querySelector("#spmd-go-code_toupper"),p=d.querySelectorAll(".code-line"),f=4,a="Hello",s=Array.from(a).map(e=>e.charCodeAt(0));let i=0,y=!0,n=!1;const o=[],l=[t.querySelector("#val-mask-0"),t.querySelector("#val-mask-1"),t.querySelector("#val-mask-2"),t.querySelector("#val-mask-3")],e=[];e.push({line:0,info:`Calling <code class="spmd-inline-code"><span class="gofn">ToUpper</span>([]<span class="goty">byte</span>("${a}"))</code>. Input string contains ${a.length} characters. Four execution lanes available.`,lanes:{},laneMask:[!1,!1,!1,!1],result:"---",isASCII:!0,hasLower:!1}),e.push({line:2,info:`Variables are initialized: <code class="spmd-inline-code"><span class="govar">hasLower</span></code> is a <code class="spmd-inline-code"><span class="gohypo">varying</span> <span class="goty">bool</span></code> (starts as false in all lanes), <code class="spmd-inline-code"><span class="govar">isASCII</span></code> is initialized to true.`,lanes:{c:Array(4).fill("---"),hasLower:Array(4).fill("false"),isLower:Array(4).fill("---"),upperC:Array(4).fill("---")},laneMask:[!1,!1,!1,!1],result:"---",isASCII:!0,hasLower:!1}),e.push({line:4,info:`First <code class="spmd-inline-code"><span class="gokw">go</span> <span class="gokw">for</span></code> loop begins. Iteration 1: Each lane processes one character in parallel (H, e, l, l).`,lanes:{c:s.slice(0,4).map(e=>`'${String.fromCharCode(e)}' (${e})`),hasLower:Array(4).fill("false"),isLower:Array(4).fill("---"),upperC:Array(4).fill("---")},laneMask:[!0,!0,!0,!0],result:"---",isASCII:!0,hasLower:!1}),e.push({line:5,info:`Check if any character is non-ASCII (>= 128). All characters are ASCII, so <code class="spmd-inline-code"><span class="gofn">reduce.Any</span>()</code> returns false and we continue.`,lanes:{c:s.slice(0,4).map(e=>`'${String.fromCharCode(e)}' (${e})`),hasLower:Array(4).fill("false"),isLower:Array(4).fill("---"),upperC:Array(4).fill("---")},laneMask:[!0,!0,!0,!0],result:"---",isASCII:!0,hasLower:!1});const u=s.slice(0,4).map(e=>{const t=String.fromCharCode(e);return t>="a"&&t<="z"?"true":"false"});e.push({line:9,info:`Check for lowercase characters in iteration 1. Lanes 1, 2, and 3 (e, l, l) detect lowercase characters and update <code class="spmd-inline-code"><span class="govar">hasLower</span></code>.`,lanes:{c:s.slice(0,4).map(e=>`'${String.fromCharCode(e)}' (${e})`),hasLower:u,isLower:u,upperC:Array(4).fill("---")},laneMask:[!0,!0,!0,!0],result:"---",isASCII:!0,hasLower:!0});const c=["false","false","false","true"];if(e.push({line:4,info:`Iteration 2: Only lane 0 processes the remaining character 'o'. Other lanes are masked out.`,lanes:{c:[`'o' (${s[4]})`,"---","---","---"],hasLower:c,isLower:["true","---","---","---"],upperC:Array(4).fill("---")},laneMask:[!0,!1,!1,!1],result:"---",isASCII:!0,hasLower:!0}),e.push({line:5,info:`Check ASCII for remaining character. 'o' is ASCII, so we continue.`,lanes:{c:[`'o' (${s[4]})`,"---","---","---"],hasLower:c,isLower:["true","---","---","---"],upperC:Array(4).fill("---")},laneMask:[!0,!1,!1,!1],result:"---",isASCII:!0,hasLower:!0}),e.push({line:9,info:`Check for lowercase in iteration 2. Lane 0 detects 'o' is lowercase and updates <code class="spmd-inline-code"><span class="govar">hasLower</span></code>.`,lanes:{c:[`'o' (${s[4]})`,"---","---","---"],hasLower:c,isLower:["true","---","---","---"],upperC:Array(4).fill("---")},laneMask:[!0,!1,!1,!1],result:"---",isASCII:!0,hasLower:!0}),n=!0,e.push({line:11,info:`First loop completes. Since all characters are ASCII, we proceed to the optimization path.`,lanes:{c:Array(4).fill("---"),hasLower:Array(4).fill("---"),isLower:Array(4).fill("---"),upperC:Array(4).fill("---")},laneMask:[!1,!1,!1,!1],result:"---",isASCII:!0,hasLower:n}),e.push({line:12,info:`Check if any lowercase characters were found using <code class="spmd-inline-code"><span class="gofn">reduce.All</span>(<span class="goop">!</span><span class="govar">hasLower</span>)</code>. This returns true only if ALL lanes have <code class="spmd-inline-code"><span class="govar">hasLower</span></code> set to false. ${n?"Since we found lowercase characters, this returns false and we proceed to convert.":"Since no lowercase was found, this returns true and we can just return a copy."}`,lanes:{c:Array(4).fill("---"),hasLower:["true","true","true","true"],isLower:Array(4).fill("---"),upperC:Array(4).fill("---")},laneMask:[!1,!1,!1,!1],result:"---",isASCII:!0,hasLower:n}),n){e.push({line:15,info:`Since we found lowercase characters, allocate a new buffer and proceed to the second <code class="spmd-inline-code"><span class="gokw">go</span> <span class="gokw">for</span></code> loop to convert characters.`,lanes:{c:Array(4).fill("---"),hasLower:Array(4).fill("---"),isLower:Array(4).fill("---"),upperC:Array(4).fill("---")},laneMask:[!1,!1,!1,!1],result:"---",isASCII:!0,hasLower:n}),e.push({line:16,info:`Second <code class="spmd-inline-code"><span class="gokw">go</span> <span class="gokw">for</span></code> loop begins. Iteration 1: Each lane processes one character for uppercase conversion (H, e, l, l).`,lanes:{c:s.slice(0,4).map(e=>`'${String.fromCharCode(e)}' (${e})`),hasLower:Array(4).fill("---"),isLower:Array(4).fill("---"),upperC:Array(4).fill("---")},laneMask:[!0,!0,!0,!0],result:"---",isASCII:!0,hasLower:n});const i=s.slice(0,4).map(e=>{const t=String.fromCharCode(e);return t>="a"&&t<="z"?"true":"false"});e.push({line:17,info:`Check if each character is lowercase and needs conversion in iteration 1. Each lane evaluates <code class="spmd-inline-code">'a' <= c && c <= 'z'</code>.`,lanes:{c:s.slice(0,4).map(e=>`'${String.fromCharCode(e)}' (${e})`),hasLower:Array(4).fill("---"),isLower:i,upperC:Array(4).fill("---")},laneMask:[!0,!0,!0,!0],result:"---",isASCII:!0,hasLower:n});const a=s.slice(0,4).map(e=>{const t=String.fromCharCode(e);if(t>="a"&&t<="z"){const t=e-("a".charCodeAt(0)-"A".charCodeAt(0));return o.push(String.fromCharCode(t)),`'${String.fromCharCode(t)}' (${t})`}return o.push(t),`'${t}' (${e})`}),r=i.map(e=>e==="true");e.push({line:18,info:`Convert lowercase characters to uppercase in iteration 1. Only lanes 1, 2, 3 (e→E, l→L, l→L) perform conversion (masked execution).`,lanes:{c:s.slice(0,4).map(e=>`'${String.fromCharCode(e)}' (${e})`),hasLower:Array(4).fill("---"),isLower:i,upperC:a},laneMask:r,result:o.join(""),isASCII:!0,hasLower:n}),e.push({line:20,info:`Store the converted (or original) characters from iteration 1 in the output buffer.`,lanes:{c:s.slice(0,4).map(e=>`'${String.fromCharCode(e)}' (${e})`),hasLower:Array(4).fill("---"),isLower:Array(4).fill("---"),upperC:a},laneMask:[!0,!0,!0,!0],result:o.join(""),isASCII:!0,hasLower:n}),e.push({line:16,info:`Iteration 2: Only lane 0 processes the remaining character 'o'. Other lanes are masked out.`,lanes:{c:[`'o' (${s[4]})`,"---","---","---"],hasLower:Array(4).fill("---"),isLower:Array(4).fill("---"),upperC:Array(4).fill("---")},laneMask:[!0,!1,!1,!1],result:o.join(""),isASCII:!0,hasLower:n}),e.push({line:17,info:`Check if 'o' is lowercase and needs conversion in iteration 2. Lane 0 evaluates <code class="spmd-inline-code">'a' <= c && c <= 'z'</code>.`,lanes:{c:[`'o' (${s[4]})`,"---","---","---"],hasLower:Array(4).fill("---"),isLower:["true","---","---","---"],upperC:Array(4).fill("---")},laneMask:[!0,!1,!1,!1],result:o.join(""),isASCII:!0,hasLower:n});const t=String.fromCharCode(s[4]-("a".charCodeAt(0)-"A".charCodeAt(0)));o.push(t),e.push({line:18,info:`Convert 'o' to uppercase (o→O) in iteration 2. Only lane 0 performs the conversion.`,lanes:{c:[`'o' (${s[4]})`,"---","---","---"],hasLower:Array(4).fill("---"),isLower:["true","---","---","---"],upperC:[`'${t}' (${t.charCodeAt(0)})`,"---","---","---"]},laneMask:[!0,!1,!1,!1],result:o.join(""),isASCII:!0,hasLower:n}),e.push({line:20,info:`Store the final converted character in the output buffer.`,lanes:{c:[`'o' (${s[4]})`,"---","---","---"],hasLower:Array(4).fill("---"),isLower:Array(4).fill("---"),upperC:[`'${t}' (${t.charCodeAt(0)})`,"---","---","---"]},laneMask:[!0,!1,!1,!1],result:o.join(""),isASCII:!0,hasLower:n})}else e.push({line:13,info:`No lowercase characters found. Return a copy of the original string without modification.`,lanes:{c:Array(4).fill("---"),hasLower:Array(4).fill("---"),isLower:Array(4).fill("---"),upperC:Array(4).fill("---")},laneMask:[!1,!1,!1,!1],result:a,isASCII:!0,hasLower:n});e.push({line:n?22:13,info:`Function completes and returns the ${n?"converted":"copied"} string.`,lanes:{c:Array(4).fill("---"),hasLower:Array(4).fill("---"),isLower:Array(4).fill("---"),upperC:Array(4).fill("---")},laneMask:[!1,!1,!1,!1],result:n?o.join(""):a,isASCII:!0,hasLower:n});function j(e){if(p.forEach(e=>e.classList.remove("highlight")),e>0){const t=d.querySelector(`#line-${e}`);t&&t.classList.add("highlight")}}function r(n){const s=e[n];j(s.line),b.innerHTML=s.info,v.textContent=s.result,g.textContent=s.isASCII;for(let e=0;e<f;e++){const i=s.lanes.c&&s.lanes.c[e]!=null?s.lanes.c[e]:"---",a=s.lanes.hasLower&&s.lanes.hasLower[e]!=null?s.lanes.hasLower[e]:"---",r=s.lanes.isLower&&s.lanes.isLower[e]!=null?s.lanes.isLower[e]:"---",c=s.lanes.upperC&&s.lanes.upperC[e]!=null?s.lanes.upperC[e]:"---",n=!!s.laneMask&&s.laneMask[e];t.querySelector(`#val-c-${e}`).textContent=i,t.querySelector(`#val-hasLower-${e}`).textContent=a,t.querySelector(`#val-isLower-${e}`).textContent=r,t.querySelector(`#val-upperC-${e}`).textContent=c,l[e].textContent=n?"true":"false";const o=[t.querySelector(`#val-c-${e}`),t.querySelector(`#val-hasLower-${e}`),t.querySelector(`#val-isLower-${e}`),t.querySelector(`#val-upperC-${e}`),l[e]];n?o.forEach(e=>e.classList.remove("inactive-lane")):o.forEach(e=>e.classList.add("inactive-lane"))}m.disabled=n===0,h.disabled=n===e.length-1}m.addEventListener("click",()=>{i>0&&(i--,r(i))}),h.addEventListener("click",()=>{i<e.length-1&&(i++,r(i))}),r(0)})</script><p>This example demonstrates two key concepts. First, we use data parallelism to quickly scan the entire string for non-ASCII characters and lowercase letters in the first <code>go for</code> loop. The <code>reduce.Any()</code> function allows us to efficiently detect if any lane found a non-ASCII character, enabling an early break from the loop.</p><p>Second, if we determine the string contains only ASCII characters and has lowercase letters, we use another <code>go for</code> loop to perform the actual uppercase conversion in parallel. Each lane processes one character, checking if it&rsquo;s lowercase and applying the conversion (<code>c -= 'a' - 'A'</code>) only when needed.</p><p>This approach leverages the fact that ASCII uppercase conversion is a simple arithmetic operation that can be efficiently vectorized, while maintaining the readability and structure of the original algorithm.</p><h2 id=summary>Summary</h2><p>These three practical examples demonstrate how a hypothetical <code>go for</code> construct could bring data parallelism to Go while maintaining the language&rsquo;s core principles of simplicity and readability. Each example showcases different aspects of SIMD programming:</p><p><strong>Printf helper</strong> shows the simplest case: parallel scanning with early termination using <code>reduce.Any()</code>. This pattern is common in string processing where you need to find the first occurrence of a character or pattern.</p><p><strong>Hexadecimal encoding</strong> illustrates how parallel computation can be combined with efficient memory access patterns. The key insight is expressing operations per-lane rather than per-iteration, allowing the compiler to automatically vectorize and adapt to different SIMD widths.</p><p><strong>bytes.ToUpper</strong> demonstrates the most sophisticated pattern: conditional execution with lane masking. The two-phase approach (scan then convert) shows how reduction operations can inform algorithmic decisions, while masked execution ensures only relevant lanes perform computation.</p><h3 id=real-world-impact>Real-World Impact</h3><p>These optimizations could significantly improve Go&rsquo;s standard library performance and any Go application. String processing, encoding/decoding, parsing, and mathematical operations are fundamental building blocks that appear in virtually every Go application. Making them faster through data parallelism would benefit the entire ecosystem without requiring developers to learn complex SIMD programming.</p><p>The <code>go for</code> construct bridges the gap between Go&rsquo;s accessibility and the performance demands of modern applications, proving, in my opinion, that readable code and high performance don&rsquo;t have to be mutually exclusive.</p><ul class=pa0></ul><div class="mt6 instapaper_ignoref"><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//bluebugs.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><div id=commento></div><script defer src=https://cdn.commento.io/js/commento.js></script></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=http://bluebugs.github.io/>&copy; Cedric Bail 2025</a><div><div class=ananke-socials></div></div></div></footer></body></html>