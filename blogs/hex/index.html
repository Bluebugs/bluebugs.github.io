<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>What if? Readable, SIMD hex convertion | Cedric Bail</title>
<meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Using an hypothetical go for construct to implement hex.go"><meta name=generator content="Hugo 0.136.0"><meta name=robots content="index, follow"><meta name=author content="Cedric Bail"><link rel=stylesheet href=/ananke/css/main.min.8921c15b0db94cb6b4846a01822db1a5540da83894c06824a2bec89cfbd30d5f.css><link rel=canonical href=http://bluebugs.github.io/blogs/hex/><meta property="og:url" content="http://bluebugs.github.io/blogs/hex/"><meta property="og:site_name" content="Cedric Bail"><meta property="og:title" content="What if? Readable, SIMD hex convertion"><meta property="og:description" content="Using an hypothetical go for construct to implement hex.go"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2025-01-12T14:38:38-07:00"><meta property="article:modified_time" content="2025-01-12T14:38:38-07:00"><meta itemprop=name content="What if? Readable, SIMD hex convertion"><meta itemprop=description content="Using an hypothetical go for construct to implement hex.go"><meta itemprop=datePublished content="2025-01-12T14:38:38-07:00"><meta itemprop=dateModified content="2025-01-12T14:38:38-07:00"><meta itemprop=wordCount content="271"><meta name=twitter:card content="summary"><meta name=twitter:title content="What if? Readable, SIMD hex convertion"><meta name=twitter:description content="Using an hypothetical go for construct to implement hex.go"></head><body class="ma0 avenir bg-near-white production"><header class="cover bg-center" style=background-image:url(http://bluebugs.github.io/images/bugaboo.jpg)><div class=bg-black-60><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Cedric Bail</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/blogs/ title="Blog page">Blog</a></li></ul><div class=ananke-socials></div></div></div></nav><div class="tc-l pv6 ph3 ph4-ns"><div class="f2 f1-l fw2 white-90 mb0 lh-title">What if? Readable, SIMD hex convertion</div><div class="fw1 f5 f3-l white-80 measure-wide-l center lh-copy mt3 mb4">Using an hypothetical go for construct to implement hex.go</div></div></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked ttu">Blog</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">What if? Readable, SIMD hex convertion</h1><p class=tracked>By <strong>Cedric Bail</strong></p><time class="f6 mv4 dib tracked" datetime=2025-01-12T14:38:38-07:00>January 12, 2025</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links black pr4-l w-two-thirds-l"><p>In my previous article, we looked at how we could introduce a more readable and maintainable way to express data parallelism in Go and used it for a quick <code>Sum</code> example. In this article, I will look at implementing <code>hex.Encode</code> and <code>hex.Decode</code> with it to start a discussion based on some more practical example.</p><h1 id=encode>Encode</h1><p>Current implementation for hex.Encode looks like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>src</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>j</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>src</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>dst</span>[<span style=color:#a6e22e>j</span>] = <span style=color:#a6e22e>hextable</span>[<span style=color:#a6e22e>v</span><span style=color:#f92672>&gt;&gt;</span><span style=color:#ae81ff>4</span>]
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>dst</span>[<span style=color:#a6e22e>j</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>] = <span style=color:#a6e22e>hextable</span>[<span style=color:#a6e22e>v</span><span style=color:#f92672>&amp;</span><span style=color:#ae81ff>0x0f</span>]
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>j</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> len(<span style=color:#a6e22e>src</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We will have to change a bit the algorithm and iterate on the <code>EncodedLen</code> of <code>src</code> to have a continuous iterator. With that in mind, let&rsquo;s see how it would look like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Encore</span>(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>src</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>idx</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>EncodedLen</span>(len(<span style=color:#a6e22e>src</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>d</span> <span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>s</span> = <span style=color:#a6e22e>src</span>[<span style=color:#a6e22e>idx</span><span style=color:#f92672>&gt;&gt;</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>idx</span> <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x1</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>v</span> = <span style=color:#a6e22e>hextable</span>[<span style=color:#a6e22e>s</span><span style=color:#f92672>&gt;&gt;</span><span style=color:#ae81ff>4</span>]
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>v</span> = <span style=color:#a6e22e>hextable</span>[<span style=color:#a6e22e>s</span><span style=color:#f92672>&amp;</span><span style=color:#ae81ff>0x0f</span>]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>dst</span>[<span style=color:#a6e22e>idx</span>] = <span style=color:#a6e22e>v</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>EncodedLen</span>(len(<span style=color:#a6e22e>src</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The code work the other way around from the original version. The compiler will know that <code>idx</code> is a continuous stream of integer. This is important as it means all memory access (both write or read are going to be continuous) and it help the compiler to be able to use SIMD instruction effectivelly. You want to keep random memory access when using SIMD to small array of known size (like <code>hextable</code>) just due to the limit of space in the instruction (It is easier to encode an access to an array as a pointer + 8bits offset, than any random pointer size).</p><h2 id=decode>Decode</h2><ul class=pa0></ul><div class="mt6 instapaper_ignoref"><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//bluebugs.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><div id=commento></div><script defer src=https://cdn.commento.io/js/commento.js></script></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=http://bluebugs.github.io/>&copy; Cedric Bail 2025</a><div><div class=ananke-socials></div></div></div></footer></body></html>