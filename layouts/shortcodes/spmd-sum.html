<link rel="stylesheet" href="{{ (resources.Get "css/spmd-demos.css").RelPermalink }}">
<style>
    #spmd-demo_sum {
        /* ID Suffix Added */
        display: flex;
        flex-direction: column;
        font-family: sans-serif;
        border: 1px solid #ccc;
        padding: 10px;
        max-width: 900px;
        margin: 20px auto;
        background-color: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #spmd-main-content_sum {
        /* ID Suffix Added */
        display: flex;
        width: 100%;
        margin-bottom: 15px;
    }

    #spmd-code-pane_sum {
        /* ID Suffix Added */
        flex: 1;
        padding: 15px;
        background-color: #fff;
        border-right: 1px solid #eee;
        border-radius: 4px 0 0 4px;
    }

    #spmd-code-pane_sum pre {
        /* ID Suffix Added */
        background-color: #2d2d2d;
        color: #f8f8f2;
        padding: 0 10px;
        border-radius: 4px;
        overflow-x: auto;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
        font-size: 0;
        line-height: 0;
        margin: 0;
    }

    #spmd-code-pane_sum .code-line {
        /* Parent ID Suffix Reflected */
        display: block;
        transition: background-color 0.3s ease;
        margin: 0;
        padding: 0;
        font-size: 14px;
        line-height: 1.2;
    }

    #spmd-code-pane_sum #spmd-go-code_sum {
        /* ID Suffix Added to both parent and target */
        display: block;
        padding: 0;
        margin: 0;
        font-size: 14px;
        line-height: 1.2;
    }

    #spmd-code-pane_sum .highlight {
        /* Parent ID Suffix Reflected */
        background-color: #44475a;
    }

    #spmd-info-pane_sum {
        /* ID Suffix Added */
        padding: 10px;
        font-size: 0.9em;
        color: #333;
        text-align: left;
        width: 100%;
        background-color: #fff;
        border: 1px solid #eee;
        border-radius: 4px;
    }

    #spmd-info-pane_sum h4 {
        /* Parent ID Suffix Reflected */
        margin-top: 0;
        color: #555;
    }

    #spmd-final-result_sum {
        /* ID Suffix Added */
        margin-top: 20px;
        padding: 15px;
        background-color: #f0f4f8;
        border: 1px solid #ced4da;
        border-radius: 6px;
        width: 100%;
        font-size: 1em;
    }

    #spmd-final-result_sum h4 {
        /* Parent ID Suffix Reflected */
        margin-top: 0;
        margin-bottom: 12px;
        text-align: center;
        color: #334e68;
        font-size: 1.15em;
        font-weight: 600;
    }

    /* REMOVED .result-line, .spmd-result-label, .spmd-result-value-group, .spmd-equals-sign as they are in spmd-demos.css */

    /* END: Styles for Final Result */


    #spmd-viz-pane_sum {
        /* ID Suffix Added */
        flex: 1.5;
        padding: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* New Grid Styles for Lane Data */
    #spmd-lane-data-grid_sum {
        /* ID Suffix Added */
        display: grid;
        grid-template-columns: auto repeat(4, 1fr);
        /* Label col, then 4 data cols */
        gap: 5px 8px;
        /* row-gap column-gap */
        width: 100%;
        margin-bottom: 20px;
        align-items: center;
        /* Vertically align items in cells */
    }

    /* REMOVED .spmd-grid-header, .spmd-grid-label, .spmd-grid-cell as they are in spmd-demos.css */

    /* Styling for v and sum value cells */
    #spmd-lane-data-grid_sum .spmd-grid-cell[id*='-v'] {
        /* Parent ID Suffix Reflected */
        color: #28a745;
        /* Green */
        font-weight: bold;
    }

    #spmd-lane-data-grid_sum .spmd-grid-cell[id*='-s'] {
        /* Selects cells for sum values */
        color: #007bff;
        /* Blue */
        font-weight: bold;
    }

    #spmd-summation-expression_sum {
        /* ID Suffix Added */
        color: #007bff;
        /* Blue, same as s values */
        font-weight: bold;
        font-size: 1.1em;
        /* Slightly larger for emphasis */
    }

    #spmd-final-result-value_sum {
        /* ID Suffix Added */
        font-size: 1.3em;
        font-weight: bold;
        color: #17a2b8;
    }

    #spmd-controls_sum {
        /* ID Suffix Added */
        margin-top: 20px;
        text-align: center;
    }

    #spmd-controls_sum button {
        /* Parent ID Suffix Reflected */
        padding: 8px 15px;
        margin: 0 5px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    #spmd-controls_sum button:hover {
        /* Parent ID Suffix Reflected */
        background-color: #0056b3;
    }

    #spmd-controls_sum button:disabled {
        /* Parent ID Suffix Reflected */
        background-color: #ccc;
        cursor: not-allowed;
    }

    /* General Go Syntax Highlighting Styles (scoped to the demo) */
    #spmd-demo_sum .gokw {
        /* Parent ID Suffix Reflected */
        color: #c586c0;
    }

    #spmd-demo_sum .gofn {
        /* Parent ID Suffix Reflected */
        color: #dcdcaa;
    }

    #spmd-demo_sum .goty {
        /* Parent ID Suffix Reflected */
        color: #4ec9b0;
    }

    #spmd-demo_sum .gohypo {
        /* Parent ID Suffix Reflected */
        color: #ce9178;
    }

    #spmd-demo_sum .govar {
        /* Parent ID Suffix Reflected */
        color: #9cdcfe;
    }

    #spmd-demo_sum .goop {
        /* Parent ID Suffix Reflected */
        color: #d4d4d4;
    }

    #spmd-demo_sum .gopunct {
        /* Parent ID Suffix Reflected */
        color: #d4d4d4;
    }

    #spmd-demo_sum .gocomment {
        /* Parent ID Suffix Reflected */
        color: #6a9955;
    }

    #spmd-info-pane_sum .spmd-inline-code {
        /* Parent ID Suffix Reflected */
        background-color: #2d2d2d;
        color: #f8f8f2;
        padding: 0.1em 0.4em;
        border-radius: 3px;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
        font-size: 0.95em;
    }
</style>

<div id="spmd-demo_sum"> <!-- ID Suffix Added -->
    <div id="spmd-main-content_sum"> <!-- ID Suffix Added -->
        <div id="spmd-code-pane_sum"> <!-- ID Suffix Added -->
            <pre><code id="spmd-go-code_sum"> <!-- ID Suffix Added -->
<span class="code-line" data-line="1"><span class="gokw">func</span> <span class="gofn">sum</span><span class="gopunct">(</span><span class="govar">a</span> <span class="goty">[]int</span><span class="gopunct">)</span> <span class="goty">int</span> <span class="gopunct">{</span></span>
<span class="code-line" data-line="2">    <span class="gokw">var</span> <span class="govar">s</span> <span class="gohypo">varying</span> <span class="goty">int</span></span>
<span class="code-line" data-line="3">    <span class="gokw">go</span> <span class="gokw">for</span> <span class="govar">_</span><span class="gopunct">,</span> <span class="govar">v</span> <span class="goop">:=</span> <span class="gokw">range</span> <span class="govar">a</span> <span class="gopunct">{</span></span>
<span class="code-line" data-line="4">        <span class="govar">s</span> <span class="goop">+=</span> <span class="govar">v</span></span>
<span class="code-line" data-line="5">    <span class="gopunct">}</span></span>
<span class="code-line" data-line="6">    <span class="gokw">return</span> <span class="gofn">reduce.Add</span><span class="gopunct">(</span><span class="govar">s</span><span class="gopunct">)</span></span>
<span class="code-line" data-line="7"><span class="gopunct">}</span></span>
    </code></pre>
        </div>

        <div id="spmd-viz-pane_sum"> <!-- ID Suffix Added -->
            <div id="spmd-lane-data-grid_sum"> <!-- ID Suffix Added -->
                <!-- Row 1: Lane Titles -->
                <div class="spmd-grid-label"></div>
                <div class="spmd-grid-header">Lane 1</div>
                <div class="spmd-grid-header">Lane 2</div>
                <div class="spmd-grid-header">Lane 3</div>
                <div class="spmd-grid-header">Lane 4</div>

                <!-- Row 2: v values -->
                <div class="spmd-grid-label">v:</div>
                <div class="spmd-grid-cell" id="spmd-lane-0-v_sum">-</div> <!-- ID Suffix Added -->
                <div class="spmd-grid-cell" id="spmd-lane-1-v_sum">-</div> <!-- ID Suffix Added -->
                <div class="spmd-grid-cell" id="spmd-lane-2-v_sum">-</div> <!-- ID Suffix Added -->
                <div class="spmd-grid-cell" id="spmd-lane-3-v_sum">-</div> <!-- ID Suffix Added -->

                <!-- Row 3: sum values -->
                <div class="spmd-grid-label">s:</div>
                <div class="spmd-grid-cell" id="spmd-lane-0-s_sum">0</div> <!-- ID Suffix Added -->
                <div class="spmd-grid-cell" id="spmd-lane-1-s_sum">0</div> <!-- ID Suffix Added -->
                <div class="spmd-grid-cell" id="spmd-lane-2-s_sum">0</div> <!-- ID Suffix Added -->
                <div class="spmd-grid-cell" id="spmd-lane-3-s_sum">0</div> <!-- ID Suffix Added -->
            </div>

            <div id="spmd-final-result_sum"> <!-- ID Suffix Added -->
                <h4>Final Result</h4>
                <div class="result-lines-container">
                    <div class="result-line">
                        <span class="spmd-result-label">reduce.Add:</span> <!-- Changed text here -->
                        <span class="spmd-result-value-group"><span id="spmd-summation-expression_sum"></span> <span
                                class="spmd-equals-sign" id="spmd-equals-sign_sum" style="display: none;">=</span> <span
                                id="spmd-final-result-value_sum">N/A</span></span> <!-- ID Suffixes Added -->
                    </div>
                </div>
            </div>
            <div id="spmd-controls_sum"> <!-- ID Suffix Added -->
                <button id="spmd-prev-step_sum">Previous</button> <!-- ID Suffix Added -->
                <button id="spmd-next-step_sum">Next</button> <!-- ID Suffix Added -->
            </div>
        </div>
    </div>

    <div id="spmd-info-pane_sum"> <!-- ID Suffix Added -->
        <h4>Execution Step:</h4>
        <p id="spmd-step-description_sum">Initialize `a` with `[]int{1,2,3,4,5,6}`. Four execution lanes available.</p>
        <!-- ID Suffix Added -->
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const codeLines_sum = document.querySelectorAll('#spmd-go-code_sum .code-line'); /* ID Suffix Added */
        const stepDescription_sum = document.getElementById('spmd-step-description_sum'); /* ID Suffix Added */

        const laneVCells_sum = [
            document.getElementById('spmd-lane-0-v_sum'), /* ID Suffix Added */
            document.getElementById('spmd-lane-1-v_sum'), /* ID Suffix Added */
            document.getElementById('spmd-lane-2-v_sum'), /* ID Suffix Added */
            document.getElementById('spmd-lane-3-v_sum')  /* ID Suffix Added */
        ];
        const laneSCells_sum = [
            document.getElementById('spmd-lane-0-s_sum'), /* ID Suffix Added */
            document.getElementById('spmd-lane-1-s_sum'), /* ID Suffix Added */
            document.getElementById('spmd-lane-2-s_sum'), /* ID Suffix Added */
            document.getElementById('spmd-lane-3-s_sum')  /* ID Suffix Added */
        ];

        const finalResultValue_sum = document.getElementById('spmd-final-result-value_sum'); /* ID Suffix Added */
        const summationExpressionElement_sum = document.getElementById('spmd-summation-expression_sum'); /* ID Suffix Added */
        const equalsSignElement_sum = document.getElementById('spmd-equals-sign_sum'); /* ID Suffix Added */
        const prevButton_sum = document.getElementById('spmd-prev-step_sum'); /* ID Suffix Added */
        const nextButton_sum = document.getElementById('spmd-next-step_sum'); /* ID Suffix Added */

        const numLanes_sum = 4;

        const steps_sum = [
            { // 0
                line: null,
                description: "Calling <span class='spmd-inline-code'><span class='gofn'>sum</span><span class='gopunct'>(</span><span class='goty'>[]int</span><span class='gopunct'>{>{</span>1,2,3,4,5,6<span class='gopunct'><}</span><span class='gopunct'>)</span></span> which initializes <span class='spmd-inline-code'><span class='govar'>a</span> = <span class='goty'>[]int</span><span class='gopunct'>{>{</span>1,2,3,4,5,6<span class='gopunct'><}</span></span>.",
                laneVDisplay: ["-", "-", "-", "-"],
                laneSDisplay: [0, 0, 0, 0],
                finalResult: "N/A"
            },
            { // 1
                line: 2,
                description: "<span class='spmd-inline-code'><span class='gokw'>var</span> <span class='govar'>s</span> <span class='gohypo'>varying</span> <span class='goty'>int</span></span>: Each lane gets its own <span class='spmd-inline-code'><span class='govar'>s</span></span> initialized to 0.",
                laneVDisplay: ["-", "-", "-", "-"],
                laneSDisplay: [0, 0, 0, 0],
                finalResult: "N/A"
            },
            { // 2: v values assigned
                line: 3,
                description: "Next, <span class='spmd-inline-code'><span class='gokw'>go</span> <span class='gokw'>for</span> <span class='govar'>_</span><span class='gopunct'>,</span> <span class='govar'>v</span> <span class='goop'>:=</span> <span class='gokw'>range</span> <span class='govar'>a</span></span> distributes the first batch of data: <span class='spmd-inline-code'><span class='govar'>v</span>=1</span> to Lane 1, <span class='spmd-inline-code'><span class='govar'>v</span>=2</span> to Lane 2, <span class='spmd-inline-code'><span class='govar'>v</span>=3</span> to Lane 3, and <span class='spmd-inline-code'><span class='govar'>v</span>=4</span> to Lane 4.",
                laneVDisplay: [1, 2, 3, 4],
                laneSDisplay: [0, 0, 0, 0],
                finalResult: "N/A"
            },
            { // 3: sums updated with v
                line: 4,
                description: "Then, <span class='spmd-inline-code'><span class='govar'>s</span> <span class='goop'>+=</span> <span class='govar'>v</span></span> executes. For lanes 1, 2, 3, and 4, the current value of <span class='spmd-inline-code'><span class='govar'>s</span></span> (which is 0 for all) is added to their assigned <span class='spmd-inline-code'><span class='govar'>v</span></span>. The result is stored back in <span class='spmd-inline-code'><span class='govar'>s</span></span> for each lane.",
                laneVDisplay: [1, 2, 3, 4],
                laneSDisplay: [1, 2, 3, 4],
                finalResult: "N/A"
            },
            { // 4: next batch of v values
                line: 3,
                description: "The <span class='spmd-inline-code'><span class='gokw'>go</span> <span class='gokw'>for</span></span> loop continues, distributing the next batch: <span class='spmd-inline-code'><span class='govar'>v</span>=5</span> to Lane 1 and <span class='spmd-inline-code'><span class='govar'>v</span>=6</span> to Lane 2. Lanes 3 and 4 are idle for new <span class='spmd-inline-code'><span class='govar'>v</span></span> assignments as there's no more data for them.",
                laneVDisplay: [5, 6, "-", "-"],
                laneSDisplay: [1, 2, 3, 4], // s values from previous step
                finalResult: "N/A"
            },
            { // 5: sums updated with new v
                line: 4,
                description: "<span class='spmd-inline-code'><span class='govar'>s</span> <span class='goop'>+=</span> <span class='govar'>v</span></span> executes again. For lanes 1 and 2, their current <span class='spmd-inline-code'><span class='govar'>s</span></span> is added to their new <span class='spmd-inline-code'><span class='govar'>v</span></span>. Lane 1: <span class='spmd-inline-code'>1 + 5 = 6</span>. Lane 2: <span class='spmd-inline-code'>2 + 6 = 8</span>. The <span class='spmd-inline-code><span class='govar'>s</span></span> values for Lanes 3 and 4 remain unchanged.",
                laneVDisplay: [5, 6, "-", "-"],
                laneSDisplay: [1 + 5, 2 + 6, 3, 4],
                finalResult: "N/A"
            },
            { // 6: Loop finished
                line: 5,
                description: "The loop finishes as all elements from <span class='spmd-inline-code'><span class='govar'>a</span></span> have been processed. The <span class='spmd-inline-code'><span class='govar'>s</span></span> values in each lane are now: Lane 1: 6, Lane 2: 8, Lane 3: 3, Lane 4: 4.",
                laneVDisplay: ["-", "-", "-", "-"],
                laneSDisplay: [6, 8, 3, 4],
                finalResult: "N/A"
            },
            { // 7: Reduce.Add
                line: 6,
                description: "Finally, <span class='spmd-inline-code'><span class='gokw'>return</span> <span class='gofn'>reduce.Add</span><span class='gopunct'>(</span><span class='govar'>s</span><span class='gopunct'>)</span></span> aggregates the <span class='spmd-inline-code'><span class='govar'>s</span></span> values from all lanes: <span class='spmd-inline-code'>6 + 8 + 3 + 4 = 21</span>.",
                laneVDisplay: ["-", "-", "-", "-"],
                laneSDisplay: [6, 8, 3, 4],
                finalResult: 21
            },
            { // 8: Return
                line: 7,
                description: "The function returns the total sum: <span class='spmd-inline-code'>21</span>.",
                laneVDisplay: ["-", "-", "-", "-"],
                laneSDisplay: [6, 8, 3, 4],
                finalResult: 21
            }
        ];

        let currentStep_sum = 0;

        function renderStep_sum(stepIndex) {
            const step = steps_sum[stepIndex];

            // Highlight code line
            codeLines_sum.forEach(line => line.classList.remove('highlight'));
            if (step.line !== null) {
                const lineToHighlight = document.querySelector(`#spmd-go-code_sum .code-line[data-line="${step.line}"]`); /* ID Suffix Added */
                if (lineToHighlight) {
                    lineToHighlight.classList.add('highlight');
                }
            }

            // Update description
            stepDescription_sum.innerHTML = step.description;

            // Update lane v and s cell textContent
            for (let i = 0; i < numLanes_sum; i++) {
                laneVCells_sum[i].textContent = step.laneVDisplay[i];
                laneSCells_sum[i].textContent = step.laneSDisplay[i];
            }

            // Update final result display
            if (step.finalResult !== "N/A") {
                // Filter out non-numeric values before joining for the expression
                const validLaneSValues = step.laneSDisplay.filter(val => typeof val === 'number');
                summationExpressionElement_sum.textContent = validLaneSValues.join(' + ');
                equalsSignElement_sum.style.display = 'inline';
                finalResultValue_sum.textContent = step.finalResult;
            } else {
                summationExpressionElement_sum.textContent = '';
                equalsSignElement_sum.style.display = 'none';
                finalResultValue_sum.textContent = "N/A";
            }

            // Update button states
            prevButton_sum.disabled = stepIndex === 0;
            nextButton_sum.disabled = stepIndex === steps_sum.length - 1;
        }

        prevButton_sum.addEventListener('click', () => {
            if (currentStep_sum > 0) {
                currentStep_sum--;
                renderStep_sum(currentStep_sum);
            }
        });

        nextButton_sum.addEventListener('click', () => {
            if (currentStep_sum < steps_sum.length - 1) {
                currentStep_sum++;
                renderStep_sum(currentStep_sum);
            }
        });

        // Initial render
        renderStep_sum(currentStep_sum);
    });
</script>